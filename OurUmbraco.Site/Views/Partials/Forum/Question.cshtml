@inherits Umbraco.Web.Mvc.UmbracoViewPage<uForum.Models.Topic>
@using uForum;

@{
    var topicAuthor = Model.Author();
    var forum = Umbraco.TypedContent(Model.ParentId);
}

<li class="comment question" id="comment-@Model.Id" data-deepLink="@Model.Title">
    <!-- Start of question -->
    <div class="meta">
        <div class="profile">
            <a href="/member/@topicAuthor.Id">@topicAuthor.Name</a> has in total, @topicAuthor.Karma() karma points
        </div>
        <div class="time">
            @Model.Created.ConvertToRelativeTime()
        </div>
    </div>

    <div class="comment-inner">
        <a href="/member/@topicAuthor.Id" class="photo">
            @avatar(topicAuthor, 48)
            <span class="karma">Recieved 5 <br>Karma points</span>
        </a>
        <div class="body-meta">
            <div class="topic">
                <h2>@Model.Title</h2>
            </div>
            <div class="categories">
                <div class="category core">
                    <a href="@forum.Url">@forum.Name</a>
                </div>

                @if (Model.Version > 0)
                {
                    <div class="version">
                        <a href="#">Umbraco @Model.Version</a>
                    </div>
                }
            </div>
        </div>

        <div class="body">
            @Model.Body.Sanitize()
        </div>
    </div>

    <div class="actions">
        <a href="#" class="copy-link" data-id="@Model.Id">
            <i class="icon-Link"></i><span>Copy Link</span>
        </a>

        <a href="#" data-topic="@Model.Id" data-controller="comment" class="reply forum-reply">
            <i class="icon-Reply-arrow"></i><span>Reply</span>
        </a>

        <a href="#" class="delete-reply">
            <i class="icon-Delete-key"></i><span>Delete post</span>
        </a>

        <a href="#" class="mark-as-spam">
            <i class="icon-Alert-alt"></i><span>Mark as spam</span>
        </a>

        <a href="#" class="edit-post">
            <i class="icon-Edit"></i><span>Edit post</span>
        </a>

    </div>
</li> <!-- End of question -->
@helper avatar(IPublishedContent member, int avatarSize)
{
    if (member.HasValue("avatar"))
    {
        @localAvatar(member.GetPropertyValue("avatar").ToString(), avatarSize);
    }
    else
    {
        @gravatar(member.GetPropertyValue("Email").ToString(), avatarSize);
    }
}


@helper gravatar(string email, int size)
{
    var emailId = email.ToLower();
    var hash = FormsAuthentication.HashPasswordForStoringInConfigFile(emailId, "MD5").ToLower();

    <img src="http://www.gravatar.com/avatar/@hash?s=@size&d=mm&r=g" />
}

@helper localAvatar(string imgPath, int size)
{
    <img src="@imgPath" alt="Alternate Text" />
}