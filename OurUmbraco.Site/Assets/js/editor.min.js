(function () {
    var converter = new Markdown.getSanitizingConverter();
    var editor = new Markdown.Editor(converter);
    var state = {};


    var thisEditor = $('#markdown-editor'),
        thisButtonRow = $('.wmd-button-row'),
        thisEditorInput = $('.wmd-input'),
        thisEditorPreview = $('.wmd-preview'),
        thisEditorDraft = $('.draft'),
        thisEditorSpacer = $('.markdown-spacer'),
        thisEditorMobilePreview = $('#mobile-preview');

    //image upload
    var $dialog = $('#insert-image-dialog');
    var $loader = $('.span', $dialog);
    var $url = $('input[type=text]', $dialog);
    var $file = $('input[type=file]', $dialog);
    var $cancel = $('input[type=button]', $dialog);

    editor.hooks.set('insertImageDialog', function (callback) {

        $dialog.show().addClass('show');

        var uploadStart = function () {
            $loader.show();
        };

        var uploadComplete = function (response) {
            $loader.hide();
            
            if (response.success) {
                callback(response.imagePath);
                $dialog.hide();
            } else {
                alert(response.message);
                $file.val('');
            }
        };

        $file.unbind('change').ajaxfileupload({
            action: $file.attr('data-action'),
            onStart: uploadStart,
            onComplete: uploadComplete
        });

        $cancel.click(function () {
            $dialog.hide();
            callback(null);
        });
        return true;
    });

    $(thisEditorInput).change(function () {
        thisEditorDraft.removeClass('show');
        if (typeof (Storage) !== 'undefined') {
            localStorage.setItem('ufdraft', $(this).val());
        }
    });

    editor.run();

    //duplicate code here, needs to be done better
    $("a.create-topic").on("click", function (e) {
        e.preventDefault();
        state = $(this).data();

        $("#markdown-editor div.create-topic").show();
        $("#markdown-editor div.reply-to").hide();

        initEditor($(this));

        showEditor();

        // draft
        if (typeof (Storage) !== 'undefined' && localStorage.getItem('ufdraft') != null) {
            thisEditorDraft.addClass('show');
        }
    });
    $('.forum-single-thread').on('click', '.forum-reply, .edit-post', function (e) {
        e.preventDefault();
        state = $(this).data();

        $("#markdown-editor div.create-topic").hide();
        $("#markdown-editor div.reply-to").show();
       

        initEditor($(this));

        showEditor();

    });

    // draft
    function showDraft () {
        if (typeof (Storage) !== 'undefined' && localStorage.getItem('ufdraft') != null) {
            thisEditorDraft.addClass('show');
        }
    }

    showDraft();

    $('.markdown-close').on('click', function () {
        hideEditor();
        if ($.trim(thisEditorPreview.text()) == "") {
            thisEditorDraft.addClass('show');

            if (typeof (Storage) !== 'undefined') {
                localStorage.setItem('ufdraft', thisEditorInput.val());
            }

        }
        
        showDraft();
    });

    $("#topic-submit").on("click", function (event) {
        event.preventDefault();
        var valid = true;
        if (state.controller == "comment")
        {
            valid = validateComment();
        }
        else
        {
            valid = validateThread();
        }

        if (valid) {
            $(this).attr("disabled", "disabled");
            $(this).attr('value', 'Posting');
            submit();
        } 
    });

    thisEditorInput.on('scroll', function () {
        var inputScroll = thisEditorInput.scrollTop(),
            scrolledPercentage = (inputScroll / 300) * 100,
            previewScrollHeight = document.getElementById('wmd-preview').scrollHeight,
            previewScroll = (previewScrollHeight / 100) * scrolledPercentage + 2;

        console.log(previewScroll);

        thisEditorPreview.scrollTop(previewScroll);
    });

    thisEditorDraft.on('click', function () {
        thisEditorDraft.removeClass('show');

        if (typeof (Storage) !== 'undefined' && localStorage.getItem('ufdraft') != null) {
            thisEditorInput.val(localStorage.getItem('ufdraft'));
            $(thisEditorInput).trigger('change');
        }
        showEditor();
    });


    function initEditor(ent) {

        var replyTo = "";
        if (ent.closest('.actions').length > 0) {
            replyTo = ent.closest('.actions').prevAll('.meta').find('a').text();
        } else
        {
            replyTo = $(".question:first .actions").prevAll('.meta').find('a').text()
        }
        
        $('.reply-name').html(replyTo);

        
        if (state.id) {

            if (state.controller == "comment") {
                $("#topic-submit").attr('value', 'Edit reply');
                $("#markdown-editor div.create-topic").hide();
                $("#markdown-editor div.reply-to").show();
                community.getCommentMarkdown(state.id).done(function (md) {

                    thisEditorInput.val(md);
                });;
            }
            else
            {
                $("#topic-submit").attr('value', 'Edit thread');
                $("#markdown-editor div.create-topic").show();
                $("#markdown-editor div.reply-to").hide();

                var threadData = $(".question").data();
                var title = $(".question h2").text();
              
                community.getThreadMarkdown(state.id).done(function (md) {

                    thisEditorInput.val(md);
                });;

                $("#topic-title").val(title);
                $("#topic-category").val(threadData.cat);
                $("#topic-version").val(threadData.version);
            }
            
        }
        else
        {
            $("#topic-submit").attr('value', 'Post reply');
        }

    }

    function submit() {

        var type = "Post";
        if (state.id) {
            type = "Put";
        } else {
            state.id = "";
        }

        var url = "/umbraco/api/forum/" + state.controller + "/" + state.id;
        state.body = thisEditorInput.val();

        
        state.title = $("#topic-title").val();
        state.forum = parseInt($("#topic-category").val());
        state.version = parseInt($("#topic-version").val());
        
        console.log(state);
        $.ajax({
            url: url,
            type: type,
            data: state
        }).done(function (data) {

            if (typeof (Storage) !== 'undefined') {
                localStorage.removeItem('ufdraft')
            }

            if (type == "Post") {

                if (state.controller == "comment") {

                    //new comment we'll use mustace to insert it into the dom
                    data.lower = function () {
                        return function (text, render) {
                            return render(text).toLowerCase();
                        }
                    };

                    data.canHaveChildren = data.parent == 0;
                    var template = $('#comment-template').html();
                    var rendered = Mustache.render(template, data);

                    if (data.parent == 0) {
                        $(".comments").append(rendered);

                        $("div.replybutton").insertAfter($("#comment-" + data.id));

                    }
                    else {
                        $(rendered).insertAfter("#comment-" + data.parent);
                    }

                    $(document).scrollTop($("#comment-" + data.id).offset().top - 80);
                    $("#comment-" + data.id).hide();
                    $("#comment-" + data.id).fadeIn();
                }else
                {
                    //new topic, so redirect to it
                    window.location.replace(data.url);
                }
            }
            else
            {
                if (state.controller == "comment") {

                    //editing comment so updating the text
                    $(".body", "#comment-" + state.id).html(thisEditorPreview.text());
                }
                else
                {
                    //editing topic, so redir (since the parent location might have changed)
                    window.location.replace(data.url);
                }
              
            }
            thisEditorInput.val("");
            thisEditorPreview.text("");
            hideEditor();
            $("#topic-submit").attr("value", "Post reply");
            $("#topic-submit").removeAttr("disabled");
        });
    }

    function validateComment() {
        var valid = true;
        thisEditorInput.removeClass('warning');

        if (!thisEditorInput.val()) {
            thisEditorInput.addClass('warning');
            valid = false;
        }
        return valid;
    }
    function validateThread()
    {
        var valid = true;
        thisEditorInput.removeClass('warning');
        $("#topic-title").removeClass('warning');
        $("#topic-category").removeClass('warning');
        $("#topic-version").removeClass('warning');

        if (!$("#topic-title").val()) {
            $("#topic-title").addClass('warning');
            valid = false;
        }
        if (!$("#topic-category").val()) {
            $("#topic-category").addClass('warning');
            valid = false;
        }
        if (!$("#topic-version").val()) {
            $("#topic-version").addClass('warning');
            valid = false;
        }
        if (!thisEditorInput.val()) {
            thisEditorInput.addClass('warning');
            valid = false;
        }
        return valid;
       
    }
    function showEditor() {
        thisEditor.addClass('write');
        thisEditorSpacer.addClass('write');
        setTimeout(function () {
            thisEditorInput.focus().delay(600);
        }, 1000);
    }
    function hideEditor()
    {
        thisEditor.removeClass('write');
        thisEditorSpacer.removeClass('write')
    }
    thisEditorMobilePreview.on('click', function (e) {
        e.preventDefault();
        thisEditor.toggleClass('mobile-preview');
        switch ($(this).attr('value')) {
            case 'Preview':
                $(this).attr('value', 'Editor');
                break;
            case 'Editor':
                $(this).attr('value', 'Preview');
                break;
        }
    });
})();